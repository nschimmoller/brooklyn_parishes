<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brooklyn Catholic Parishes Timeline</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent-gold: #d4a853;
            --accent-gold-light: #f0d78c;
            --accent-blue: #4a6fa5;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --border-color: rgba(212, 168, 83, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--bg-card) 0%, #0f1729 100%);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
        }
        
        header::after {
            content: '‚úù';
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 4rem;
            color: rgba(212, 168, 83, 0.08);
        }
        
        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-gold);
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 300;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 380px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .search-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(74, 111, 165, 0.1) 0%, transparent 100%);
        }
        
        .search-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            color: var(--accent-gold-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-title::before {
            content: 'üîç';
            font-size: 0.75rem;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 0.75rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.6rem 2.5rem 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.85rem;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        #address-search {
            padding-right: 2.75rem;
        }
        
        .search-input:focus {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(212, 168, 83, 0.2);
        }
        
        .search-input::placeholder {
            color: var(--text-secondary);
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .autocomplete-dropdown.active {
            display: block;
        }
        
        .autocomplete-item {
            padding: 0.6rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(212, 168, 83, 0.1);
            transition: background 0.15s;
        }
        
        .autocomplete-item:hover {
            background: rgba(212, 168, 83, 0.15);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .autocomplete-name {
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .autocomplete-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }
        
        .address-result {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: rgba(74, 111, 165, 0.2);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            display: none;
        }
        
        .address-result.active {
            display: block;
        }
        
        .address-result-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-blue);
            margin-bottom: 0.35rem;
        }
        
        .address-result-parish {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            color: var(--accent-gold);
        }
        
        .address-result-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .filter-section {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filter-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            color: var(--accent-gold-light);
            margin-bottom: 0.75rem;
        }
        
        .filter-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .filter-chip {
            padding: 0.35rem 0.65rem;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .filter-chip:hover {
            background: rgba(212, 168, 83, 0.15);
            color: var(--text-primary);
        }
        
        .filter-chip.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
            border-color: var(--accent-gold);
        }
        
        .timeline-control {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(180deg, rgba(212, 168, 83, 0.05) 0%, transparent 100%);
        }
        
        .timeline-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.9rem;
            color: var(--accent-gold-light);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .timeline-title::before {
            content: '‚ß´';
            font-size: 0.6rem;
        }
        
        .year-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.6rem 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .year-value {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .year-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }
        
        .year-separator {
            width: 30px;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-blue));
            border-radius: 1px;
        }
        
        .slider-container {
            position: relative;
            height: 40px;
            margin: 0.75rem 0;
        }
        
        .slider-track {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 5px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 3px;
            transform: translateY(-50%);
        }
        
        .slider-range {
            position: absolute;
            top: 50%;
            height: 5px;
            background: linear-gradient(90deg, var(--accent-gold), var(--accent-blue));
            border-radius: 3px;
            transform: translateY(-50%);
            box-shadow: 0 0 8px rgba(212, 168, 83, 0.4);
        }
        
        .slider-thumb {
            position: absolute;
            top: 50%;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #b8943f 100%);
            border: 2px solid var(--bg-card);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5), 0 0 0 2px rgba(212, 168, 83, 0.3);
            transition: transform 0.1s, box-shadow 0.2s;
        }
        
        .slider-thumb:hover {
            transform: translate(-50%, -50%) scale(1.15);
        }
        
        .slider-thumb:active {
            cursor: grabbing;
        }
        
        .slider-thumb::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 6px;
            background: var(--bg-card);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .year-ticks {
            display: flex;
            justify-content: space-between;
            padding: 0 2px;
            margin-top: 0.35rem;
        }
        
        .year-tick {
            font-size: 0.6rem;
            color: var(--text-secondary);
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.25);
            padding: 0.5rem;
            border-radius: 5px;
            border: 1px solid rgba(212, 168, 83, 0.15);
            text-align: center;
        }
        
        .stat-number {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        
        .stat-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-top: 0.15rem;
        }
        
        .parish-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }
        
        .parish-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .parish-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }
        
        .parish-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }
        
        .list-header {
            font-family: 'Playfair Display', serif;
            font-size: 0.85rem;
            color: var(--accent-gold-light);
            margin-bottom: 0.5rem;
            padding-bottom: 0.4rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .parish-item {
            padding: 0.6rem;
            margin-bottom: 0.4rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            border-left: 3px solid var(--accent-gold);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .parish-item:hover {
            background: rgba(212, 168, 83, 0.1);
            transform: translateX(3px);
        }
        
        .parish-item.highlighted {
            background: rgba(212, 168, 83, 0.2);
            border-left-color: var(--accent-gold-light);
        }
        
        .parish-name {
            font-weight: 500;
            font-size: 0.85rem;
            margin-bottom: 0.2rem;
        }
        
        .parish-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        
        .parish-badges {
            display: flex;
            gap: 0.35rem;
            margin-top: 0.3rem;
            flex-wrap: wrap;
        }
        
        .parish-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.65rem;
        }
        
        .parish-badge.dates {
            background: rgba(212, 168, 83, 0.15);
            color: var(--accent-gold-light);
        }
        
        .parish-badge.origin {
            background: rgba(74, 111, 165, 0.25);
            color: #7ba3d4;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: #0d1117;
        }
        
        .leaflet-container {
            font-family: 'Source Sans 3', sans-serif;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .custom-popup .leaflet-popup-tip {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
        }
        
        .popup-content h3 {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }
        
        .popup-content p {
            margin: 0.25rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .popup-content .origin-badge {
            display: inline-block;
            background: rgba(74, 111, 165, 0.3);
            color: #7ba3d4;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-top: 0.35rem;
        }
        
        .popup-content .dates {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            color: var(--accent-gold-light);
            font-weight: 500;
        }
        
        .map-legend {
            position: absolute;
            bottom: 2rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            z-index: 1000;
            min-width: 160px;
        }
        
        .legend-title {
            font-family: 'Playfair Display', serif;
            font-size: 0.8rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
            padding-bottom: 0.35rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.35rem;
            font-size: 0.75rem;
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-card);
            box-shadow: 0 0 0 1px rgba(255,255,255,0.2);
        }
        
        .legend-line {
            width: 16px;
            height: 2px;
            border-radius: 1px;
        }
        
        .toggle-boundaries {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }
        
        .toggle-btn {
            width: 100%;
            padding: 0.4rem;
            background: rgba(212, 168, 83, 0.15);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .toggle-btn:hover {
            background: rgba(212, 168, 83, 0.25);
        }
        
        .toggle-btn.active {
            background: var(--accent-gold);
            color: var(--bg-dark);
        }
        
        .search-marker {
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--text-secondary);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        
        .search-loading {
            position: absolute;
            right: 10px;
            top: 50%;
            width: 16px;
            height: 16px;
            margin-top: -8px;
            border: 2px solid rgba(212, 168, 83, 0.3);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            display: none;
            box-sizing: border-box;
        }
        
        .search-loading.active {
            display: block;
            animation: spinner 0.6s linear infinite;
        }
        
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            background: var(--accent-gold);
            border: none;
            border-radius: 4px;
            color: var(--bg-dark);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, opacity 0.2s;
        }
        
        .search-btn:hover {
            background: var(--accent-gold-light);
        }
        
        .search-btn:disabled {
            opacity: 0.7;
            cursor: wait;
        }
        
        .search-btn.loading {
            background: var(--accent-gold);
        }
        
        .search-btn.loading::after {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid var(--bg-dark);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spinner 0.6s linear infinite;
        }
        
        .search-btn.loading span {
            display: none;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Map tile filter for dark theme */
        .leaflet-tile-pane {
            filter: brightness(0.8) contrast(1.1) saturate(0.8);
        }
        
        /* Mobile toggle button */
        .mobile-toggle {
            display: none;
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: var(--accent-gold);
            color: var(--bg-dark);
            border: none;
            border-radius: 30px;
            padding: 0.75rem 1.5rem;
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        
        .mobile-toggle:hover {
            background: var(--accent-gold-light);
            transform: translateX(-50%) scale(1.05);
        }
        
        .mobile-toggle::before {
            content: '‚ò∞ ';
        }
        
        .mobile-toggle.showing-controls::before {
            content: 'üó∫Ô∏è ';
        }
        
        /* Tablet styles */
        @media (max-width: 1024px) {
            .sidebar {
                width: 320px;
            }
            
            h1 {
                font-size: 1.6rem;
            }
            
            header {
                padding: 1rem 1.5rem;
            }
            
            header::after {
                font-size: 3rem;
                right: 1.5rem;
            }
        }
        
        /* Mobile styles */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile browsers */
            }
            
            header {
                padding: 0.75rem 1rem;
                text-align: center;
            }
            
            header::after {
                display: none;
            }
            
            h1 {
                font-size: 1.3rem;
                margin-bottom: 0.15rem;
            }
            
            .subtitle {
                font-size: 0.75rem;
            }
            
            .subtitle:last-child {
                display: none; /* Hide data source on mobile */
            }
            
            .main-content {
                flex-direction: column;
                position: relative;
            }
            
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-height: none;
                height: 100%;
                z-index: 1000;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                border-right: none;
                overflow-y: auto;
            }
            
            .sidebar.mobile-visible {
                transform: translateY(0);
            }
            
            .map-container {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                height: 100%;
            }
            
            .mobile-toggle {
                display: block;
            }
            
            /* Compact search section */
            .search-section {
                padding: 0.75rem 1rem;
            }
            
            .search-title {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            
            .search-container {
                margin-bottom: 0.5rem;
            }
            
            .search-input {
                padding: 0.5rem 2.5rem 0.5rem 0.6rem;
                font-size: 16px; /* Prevents iOS zoom */
            }
            
            /* Compact filter section */
            .filter-section {
                padding: 0.75rem 1rem;
            }
            
            .filter-title {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            
            .filter-chip {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
            }
            
            /* Compact timeline */
            .timeline-control {
                padding: 0.75rem 1rem;
            }
            
            .timeline-title {
                font-size: 0.8rem;
                margin-bottom: 0.5rem;
            }
            
            .year-display {
                padding: 0.5rem 0.6rem;
                margin-bottom: 0.5rem;
            }
            
            .year-value {
                font-size: 1.1rem;
            }
            
            .year-label {
                font-size: 0.6rem;
            }
            
            /* Larger touch targets for slider */
            .slider-container {
                height: 50px;
                margin: 0.5rem 0;
            }
            
            .slider-thumb {
                width: 28px;
                height: 28px;
            }
            
            .slider-thumb:hover {
                transform: translate(-50%, -50%); /* No scale on mobile */
            }
            
            .slider-track {
                height: 6px;
            }
            
            .slider-range {
                height: 6px;
            }
            
            .year-ticks {
                margin-top: 0.25rem;
            }
            
            .year-tick {
                font-size: 0.55rem;
            }
            
            .stats-panel {
                margin-top: 0.5rem;
                gap: 0.4rem;
            }
            
            .stat-box {
                padding: 0.4rem;
            }
            
            .stat-number {
                font-size: 1.25rem;
            }
            
            .stat-label {
                font-size: 0.6rem;
            }
            
            /* Parish list */
            .parish-list {
                padding: 0.5rem;
                padding-bottom: 5rem; /* Space for mobile toggle */
            }
            
            .list-header {
                font-size: 0.8rem;
                margin-bottom: 0.4rem;
                padding-bottom: 0.3rem;
            }
            
            .parish-item {
                padding: 0.5rem;
                margin-bottom: 0.3rem;
            }
            
            .parish-name {
                font-size: 0.8rem;
            }
            
            .parish-meta {
                font-size: 0.65rem;
            }
            
            .parish-badge {
                font-size: 0.6rem;
                padding: 0.1rem 0.35rem;
            }
            
            /* Map legend - move to top left and make smaller */
            .map-legend {
                bottom: auto;
                top: 0.5rem;
                right: 0.5rem;
                padding: 0.5rem;
                min-width: 130px;
                font-size: 0.7rem;
                opacity: 0.95;
            }
            
            .legend-title {
                font-size: 0.7rem;
                margin-bottom: 0.35rem;
                padding-bottom: 0.25rem;
            }
            
            .legend-item {
                margin-bottom: 0.25rem;
                font-size: 0.65rem;
            }
            
            .legend-dot {
                width: 8px;
                height: 8px;
            }
            
            .toggle-boundaries {
                margin-top: 0.35rem;
                padding-top: 0.35rem;
            }
            
            .toggle-btn {
                padding: 0.35rem;
                font-size: 0.65rem;
            }
            
            /* Address result compact */
            .address-result {
                margin-top: 0.5rem;
                padding: 0.5rem;
            }
            
            .address-result-title {
                font-size: 0.65rem;
            }
            
            .address-result-parish {
                font-size: 0.9rem;
            }
            
            .address-result-info {
                font-size: 0.7rem;
            }
            
            /* Popup adjustments */
            .popup-content h3 {
                font-size: 0.95rem;
            }
            
            .popup-content p {
                font-size: 0.8rem;
            }
            
            /* Autocomplete */
            .autocomplete-dropdown {
                max-height: 150px;
            }
            
            .autocomplete-item {
                padding: 0.5rem 0.6rem;
            }
            
            .autocomplete-name {
                font-size: 0.8rem;
            }
            
            .autocomplete-meta {
                font-size: 0.65rem;
            }
        }
        
        /* Small mobile styles */
        @media (max-width: 380px) {
            h1 {
                font-size: 1.1rem;
            }
            
            .subtitle {
                font-size: 0.65rem;
            }
            
            .filter-chip {
                padding: 0.3rem 0.5rem;
                font-size: 0.65rem;
            }
            
            .year-value {
                font-size: 1rem;
            }
            
            .map-legend {
                min-width: 110px;
                padding: 0.4rem;
            }
        }
        
        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            header {
                padding: 0.4rem 1rem;
            }
            
            h1 {
                font-size: 1.1rem;
                margin-bottom: 0;
            }
            
            .subtitle {
                display: none;
            }
            
            .sidebar {
                overflow-y: auto;
            }
            
            .search-section,
            .filter-section,
            .timeline-control {
                padding: 0.5rem 1rem;
            }
            
            .parish-list {
                max-height: 30vh;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Brooklyn Catholic Parishes</h1>
            <p class="subtitle">Interactive Historical Map ‚Ä¢ Kings County, NY ‚Ä¢ 1822‚ÄìPresent</p>
            <p class="subtitle">Data source: <a href="https://ifhf.org/wp-content/uploads/2019/09/brooklyn-parishes.pdf" target="_blank" rel="noopener" style="color: var(--accent-gold-light);">Irish Family History Forum</a></p>
        </header>
        
        <div class="main-content">
            <aside class="sidebar">
                <!-- Search Section -->
                <div class="search-section">
                    <div class="search-title">Search</div>
                    
                    <!-- Parish Search -->
                    <div class="search-container">
                        <input type="text" class="search-input" id="parish-search" 
                               placeholder="Search parishes by name..." autocomplete="off">
                        <div class="autocomplete-dropdown" id="parish-autocomplete"></div>
                    </div>
                    
                    <!-- Address Search -->
                    <div class="search-container">
                        <input type="text" class="search-input" id="address-search" 
                               placeholder="Enter address, press Enter to search" autocomplete="off">
                        <button class="search-btn" id="address-search-btn" title="Search"><span>‚èé</span></button>
                    </div>
                    
                    <!-- Address Result -->
                    <div class="address-result" id="address-result">
                        <div class="address-result-title">Your Parish</div>
                        <div class="address-result-parish" id="result-parish-name"></div>
                        <div class="address-result-info" id="result-parish-info"></div>
                    </div>
                </div>
                
                <!-- Language Filter -->
                <div class="filter-section">
                    <div class="filter-title">Filter by Language</div>
                    <div class="filter-row" id="origin-filters">
                        <div class="filter-chip active" data-origin="all">All</div>
                        <div class="filter-chip" data-origin="German">German</div>
                        <div class="filter-chip" data-origin="Polish">Polish</div>
                        <div class="filter-chip" data-origin="Italian">Italian</div>
                        <div class="filter-chip" data-origin="Slovak">Slovak</div>
                        <div class="filter-chip" data-origin="French">French</div>
                        <div class="filter-chip" data-origin="Lithuanian">Lithuanian</div>
                    </div>
                </div>
                
                <!-- Timeline Control -->
                <div class="timeline-control">
                    <div class="timeline-title">Timeline Filter</div>
                    
                    <div class="year-display">
                        <div>
                            <div class="year-label">From</div>
                            <div class="year-value" id="year-start">1822</div>
                        </div>
                        <div class="year-separator"></div>
                        <div>
                            <div class="year-label">To</div>
                            <div class="year-value" id="year-end">2025</div>
                        </div>
                    </div>
                    
                    <div class="slider-container" id="slider-container">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="slider-range"></div>
                        <div class="slider-thumb" id="thumb-start" data-thumb="start"></div>
                        <div class="slider-thumb" id="thumb-end" data-thumb="end"></div>
                    </div>
                    
                    <div class="year-ticks">
                        <span class="year-tick">1822</span>
                        <span class="year-tick">1875</span>
                        <span class="year-tick">1925</span>
                        <span class="year-tick">1975</span>
                        <span class="year-tick">2025</span>
                    </div>
                    
                    <div class="stats-panel">
                        <div class="stat-box">
                            <div class="stat-number" id="active-count">0</div>
                            <div class="stat-label">Active</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-number" id="closed-count">0</div>
                            <div class="stat-label">Closed</div>
                        </div>
                    </div>
                </div>
                
                <div class="parish-list" id="parish-list">
                    <div class="list-header">Parishes in Selected Period</div>
                </div>
            </aside>
            
            <div class="map-container">
                <div id="map"></div>
                
                <!-- Mobile Toggle Button -->
                <button class="mobile-toggle" id="mobile-toggle">Show Controls</button>
                
                <div class="map-legend">
                    <div class="legend-title">Legend</div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #d4a853;"></div>
                        <span>Active Parish</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #6b7280;"></div>
                        <span>Closed/Merged</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #ef4444;"></div>
                        <span>Search Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-line" style="background: rgba(212, 168, 83, 0.4);"></div>
                        <span>Boundary</span>
                    </div>
                    <div class="toggle-boundaries">
                        <button class="toggle-btn active" id="toggle-boundaries">
                            Show Boundaries
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Turf.js for geospatial operations -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <script>
        // ==================== UTILITY FUNCTIONS ====================
        
        /**
         * Escapes HTML special characters to prevent XSS attacks
         * @param {string} text - The text to escape
         * @returns {string} - The escaped text safe for innerHTML
         */
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Brooklyn Catholic Parishes Data (extracted from PDF)
        // Origin field captures language/ethnic specialization from the document
        const parishes = [
            { id: 1, name: "All Saints", address: "115 Throop Avenue", est: 1866, closed: null, origin: "German", lat: 40.6996, lng: -73.9419 },
            { id: 2, name: "Annunciation of the BVM", address: "259 N. 5th Street", est: 1863, closed: null, origin: "German", lat: 40.7147, lng: -73.9612 },
            { id: 3, name: "Assumption of the BVM", address: "64 Middagh Street", est: 1842, closed: null, origin: null, lat: 40.6986, lng: -73.9897 },
            { id: 4, name: "Blessed Sacrament", address: "198 Euclid Avenue", est: 1891, closed: null, origin: null, lat: 40.6774, lng: -73.8722 },
            { id: 5, name: "Epiphany", address: "96 South 9th Street", est: 1905, closed: null, origin: null, lat: 40.7108, lng: -73.9629 },
            { id: 6, name: "Fourteen Holy Martyrs", address: "Central Ave. and Covert St.", est: 1887, closed: 1976, origin: null, lat: 40.6944, lng: -73.9183, note: "See St. Martin of Tours" },
            { id: 7, name: "Good Shepherd", address: "1950 Batchelder Street", est: 1927, closed: null, origin: null, lat: 40.5978, lng: -73.9341 },
            { id: 8, name: "Guardian Angel", address: "2978 Ocean Parkway", est: 1885, closed: null, origin: null, lat: 40.5831, lng: -73.9681 },
            { id: 9, name: "Holy Cross", address: "2530 Church Avenue", est: 1845, closed: null, origin: null, lat: 40.6502, lng: -73.9499 },
            { id: 10, name: "Holy Family", address: "205 14th Street", est: 1880, closed: null, origin: null, lat: 40.6648, lng: -73.9953 },
            { id: 11, name: "Holy Family (Flatlands)", address: "9719 Flatlands Avenue", est: 1880, closed: null, origin: null, lat: 40.6246, lng: -73.8969 },
            { id: 12, name: "Holy Family (Slovak)", address: "21 Nassau Avenue", est: 1905, closed: null, origin: "Slovak", lat: 40.7235, lng: -73.9518 },
            { id: 14, name: "Holy Innocents", address: "279 East 17th Street", est: 1909, closed: null, origin: null, lat: 40.6448, lng: -73.9599 },
            { id: 15, name: "Holy Name", address: "245 Prospect Park West", est: 1878, closed: null, origin: null, lat: 40.6582, lng: -73.9788 },
            { id: 16, name: "Holy Rosary", address: "141 Chauncey Street", est: 1889, closed: null, origin: null, lat: 40.6831, lng: -73.9133 },
            { id: 17, name: "Holy Spirit", address: "1712 45th Street", est: 1919, closed: null, origin: null, lat: 40.6354, lng: -73.9889 },
            { id: 18, name: "Immaculate Conception", address: "72 Maujer Street", est: 1853, closed: null, origin: null, lat: 40.7082, lng: -73.9438 },
            { id: 19, name: "Immaculate Heart of Mary", address: "2805 Fort Hamilton Parkway", est: 1893, closed: null, origin: null, lat: 40.6383, lng: -73.9854 },
            { id: 20, name: "Mary Queen of Heaven", address: "1395 East 56th Street", est: 1927, closed: null, origin: null, lat: 40.6155, lng: -73.9094 },
            { id: 21, name: "Most Holy Trinity", address: "138 Montrose Avenue", est: 1841, closed: null, origin: "German", lat: 40.7083, lng: -73.9436 },
            { id: 22, name: "Nativity of Our Blessed Lord", address: "Classon and Madison Avenues", est: 1871, closed: 1973, origin: null, lat: 40.6843, lng: -73.9607, note: "Became St. Peter Claver" },
            { id: 23, name: "Our Lady Help of Christians", address: "1315 East 28th Street", est: 1927, closed: null, origin: null, lat: 40.6266, lng: -73.9489 },
            { id: 24, name: "Our Lady of Angels", address: "7320 4th Avenue", est: 1891, closed: null, origin: null, lat: 40.6315, lng: -74.0288 },
            { id: 25, name: "Our Lady of Charity", address: "1669 Dean Street", est: 1903, closed: null, origin: null, lat: 40.6784, lng: -73.9334 },
            { id: 26, name: "Our Lady of Consolation", address: "184 Metropolitan Avenue", est: 1909, closed: null, origin: "Polish", lat: 40.7145, lng: -73.9518 },
            { id: 27, name: "Our Lady of Czestochowa-St. Casimir", address: "183 25th Street", est: 1896, closed: null, origin: "Polish", lat: 40.6585, lng: -74.0034 },
            { id: 28, name: "Our Lady of Good Counsel", address: "915 Putnam Avenue", est: 1886, closed: null, origin: null, lat: 40.6843, lng: -73.9287 },
            { id: 29, name: "Our Lady of Grace", address: "430 Avenue W", est: 1935, closed: null, origin: null, lat: 40.5972, lng: -73.9654 },
            { id: 30, name: "Our Lady of Guadalupe", address: "7201 15th Avenue", est: 1906, closed: null, origin: null, lat: 40.6246, lng: -74.0001 },
            { id: 31, name: "Our Lady of Loreto", address: "124 Sackman Street", est: 1894, closed: null, origin: null, lat: 40.6720, lng: -73.9012 },
            { id: 32, name: "Our Lady of Lourdes", address: "11 DeSales Place", est: 1872, closed: null, origin: null, lat: 40.6798, lng: -73.8821 },
            { id: 33, name: "Our Lady of Mercy (old)", address: "DeKalb and Debevoise Avenues", est: 1857, closed: 1930, origin: null, lat: 40.6984, lng: -73.9366 },
            { id: 34, name: "Our Lady of Mercy", address: "680 Mother Gaston Blvd.", est: 1961, closed: null, origin: null, lat: 40.6692, lng: -73.9021 },
            { id: 35, name: "Our Lady of Miracles", address: "757 East 86th Street", est: 1936, closed: null, origin: null, lat: 40.6133, lng: -73.9189 },
            { id: 36, name: "Our Lady of Mount Carmel", address: "275 North 8th Street", est: 1887, closed: null, origin: "Italian", lat: 40.7176, lng: -73.9591 },
            { id: 37, name: "Our Lady of Peace", address: "522 Carroll Street", est: 1901, closed: null, origin: null, lat: 40.6776, lng: -73.9851 },
            { id: 38, name: "Our Lady of Perpetual Help", address: "526 59th Street", est: 1894, closed: null, origin: null, lat: 40.6389, lng: -74.0211 },
            { id: 39, name: "Our Lady of Presentation", address: "8007 4th Avenue", est: 1922, closed: null, origin: null, lat: 40.6211, lng: -74.0285 },
            { id: 40, name: "Our Lady of Refuge", address: "2020 Foster Avenue", est: 1909, closed: null, origin: null, lat: 40.6372, lng: -73.9487 },
            { id: 41, name: "Our Lady of Solace", address: "2866 West 17th Street", est: 1910, closed: null, origin: null, lat: 40.5774, lng: -73.9848 },
            { id: 42, name: "Our Lady of Sorrows", address: "103 Pitt Street", est: 1867, closed: null, origin: null, lat: 40.6898, lng: -73.8854 },
            { id: 43, name: "Our Lady of Trust", address: "1614 Cropsey Avenue", est: 1951, closed: null, origin: null, lat: 40.5945, lng: -73.9944 },
            { id: 44, name: "Our Lady of Victory", address: "583 Throop Avenue", est: 1895, closed: null, origin: null, lat: 40.6882, lng: -73.9420 },
            { id: 45, name: "Our Lady Queen of Martyrs", address: "71 Adelphi Street", est: 1962, closed: null, origin: null, lat: 40.6914, lng: -73.9732 },
            { id: 46, name: "Precious Blood", address: "3rd Avenue and 6th Street", est: 1872, closed: 1939, origin: null, lat: 40.6728, lng: -74.0003, note: "Closed 1939" },
            { id: 48, name: "Queen of All Saints", address: "300 Vanderbilt Avenue", est: 1913, closed: null, origin: null, lat: 40.6869, lng: -73.9693 },
            { id: 49, name: "Resurrection", address: "2201 Gerritsen Avenue", est: 1925, closed: null, origin: null, lat: 40.5887, lng: -73.9223 },
            { id: 50, name: "Sacred Heart", address: "325 Degraw Street", est: 1863, closed: null, origin: null, lat: 40.6820, lng: -73.9880 },
            { id: 51, name: "Sacred Heart of Jesus", address: "125 Parkville Avenue", est: 1879, closed: null, origin: "Italian", lat: 40.6394, lng: -73.9790 },
            { id: 52, name: "Sacred Hearts of Jesus and Mary & St. Stephen", address: "125 Summit Street", est: 1869, closed: null, origin: null, lat: 40.6835, lng: -74.0032 },
            { id: 53, name: "Sacred Hearts-St. Stephen", address: "108 Carroll Street", est: 1870, closed: null, origin: null, lat: 40.6808, lng: -74.0018 },
            { id: 54, name: "St. Agatha", address: "736 48th Street", est: 1917, closed: null, origin: null, lat: 40.6377, lng: -74.0116 },
            { id: 55, name: "St. Agnes", address: "417 Sackett Street", est: 1858, closed: null, origin: null, lat: 40.6805, lng: -73.9934 },
            { id: 56, name: "St. Ambrose", address: "267 Throop Avenue", est: 1903, closed: null, origin: null, lat: 40.6943, lng: -73.9423 },
            { id: 57, name: "St. Andrew the Apostle", address: "353 Hicks Street", est: 1852, closed: null, origin: null, lat: 40.6921, lng: -73.9985 },
            { id: 58, name: "St. Anselm", address: "365 83rd Street", est: 1904, closed: null, origin: null, lat: 40.6214, lng: -74.0263 },
            { id: 59, name: "St. Anthony of Padua", address: "832 Manhattan Avenue", est: 1874, closed: null, origin: null, lat: 40.7284, lng: -73.9541 },
            { id: 60, name: "St. Anthony of Padua-St. Alphonsus", address: "862 4th Avenue", est: 1874, closed: null, origin: null, lat: 40.6558, lng: -73.9958 },
            { id: 61, name: "St. Athanasius", address: "2154 61st Street", est: 1925, closed: null, origin: null, lat: 40.6175, lng: -73.9180 },
            { id: 62, name: "St. Augustine", address: "116 6th Avenue", est: 1870, closed: null, origin: null, lat: 40.6782, lng: -73.9863 },
            { id: 63, name: "St. Barbara", address: "138 Bleecker Street", est: 1893, closed: null, origin: "Italian", lat: 40.6996, lng: -73.9132 },
            { id: 64, name: "St. Benedict Joseph", address: "364 New Jersey Avenue", est: 1897, closed: null, origin: null, lat: 40.6768, lng: -73.8807 },
            { id: 65, name: "St. Bernadette", address: "8201 13th Avenue", est: 1937, closed: null, origin: null, lat: 40.6176, lng: -73.9996 },
            { id: 66, name: "St. Bernard", address: "2055 East 69th Street", est: 1910, closed: null, origin: null, lat: 40.6153, lng: -73.9013 },
            { id: 67, name: "St. Boniface", address: "109 Willoughby Street", est: 1853, closed: null, origin: "German", lat: 40.6927, lng: -73.9839 },
            { id: 68, name: "St. Brendan", address: "525 East 45th Street", est: 1913, closed: null, origin: null, lat: 40.6321, lng: -73.9318 },
            { id: 69, name: "St. Brigid", address: "409 Linden Street", est: 1854, closed: null, origin: null, lat: 40.6943, lng: -73.9076 },
            { id: 70, name: "St. Catherine of Alexandria", address: "1097 Eastern Parkway", est: 1886, closed: null, origin: null, lat: 40.6709, lng: -73.9427 },
            { id: 71, name: "St. Catherine of Genoa", address: "4502 Avenue D", est: 1918, closed: null, origin: null, lat: 40.6261, lng: -73.9301 },
            { id: 72, name: "St. Cecilia", address: "84 Herbert Street", est: 1871, closed: null, origin: null, lat: 40.7229, lng: -73.9442 },
            { id: 73, name: "St. Charles Borromeo", address: "21 Sidney Place", est: 1868, closed: null, origin: null, lat: 40.6896, lng: -73.9924 },
            { id: 74, name: "St. Clare", address: "718 E. 13th Street", est: 1927, closed: null, origin: null, lat: 40.6252, lng: -73.9511 },
            { id: 75, name: "St. Columba", address: "2245 Kimball Street", est: 1913, closed: null, origin: null, lat: 40.5979, lng: -73.9225 },
            { id: 76, name: "St. Cyril of Alexandria", address: "62 Powers Street", est: 1897, closed: null, origin: "Polish", lat: 40.7073, lng: -73.9438 },
            { id: 77, name: "St. Dominic", address: "555 Mother Gaston Boulevard", est: 1911, closed: null, origin: null, lat: 40.6679, lng: -73.9023 },
            { id: 78, name: "St. Edmund", address: "1902 Avenue T", est: 1924, closed: null, origin: null, lat: 40.6035, lng: -73.9448 },
            { id: 79, name: "St. Ephrem", address: "929 Bay Ridge Parkway", est: 1912, closed: null, origin: null, lat: 40.6226, lng: -74.0131 },
            { id: 80, name: "St. Finbar", address: "1839 Bath Avenue", est: 1917, closed: null, origin: null, lat: 40.6009, lng: -73.9903 },
            { id: 81, name: "St. Frances Cabrini", address: "4002 Avenue K", est: 1947, closed: null, origin: null, lat: 40.6265, lng: -73.9232 },
            { id: 82, name: "St. Frances de Chantal", address: "1273 58th Street", est: 1935, closed: null, origin: null, lat: 40.6259, lng: -73.9757 },
            { id: 83, name: "St. Francis Assisi", address: "401 Lincoln Road", est: 1900, closed: null, origin: null, lat: 40.6542, lng: -73.9570 },
            { id: 84, name: "St. Francis of Paola", address: "210 Skillman Street", est: 1904, closed: null, origin: "Italian", lat: 40.7013, lng: -73.9341 },
            { id: 85, name: "St. Francis Xavier", address: "255 President Street", est: 1881, closed: null, origin: null, lat: 40.6798, lng: -73.9812 },
            { id: 86, name: "St. Gabriel", address: "331 Hawthorne Street", est: 1908, closed: null, origin: null, lat: 40.6551, lng: -73.9520 },
            { id: 87, name: "St. George", address: "York and Gold Streets", est: 1909, closed: 1957, origin: "Lithuanian", lat: 40.6962, lng: -73.9843 },
            { id: 88, name: "St. Gregory the Great", address: "224 Brooklyn Avenue", est: 1905, closed: null, origin: null, lat: 40.6667, lng: -73.9307 },
            { id: 89, name: "St. Ignatius Loyola", address: "1101 Carroll Street", est: 1908, closed: null, origin: null, lat: 40.6680, lng: -73.9499 },
            { id: 90, name: "St. James Cathedral", address: "250 Cathedral Place", est: 1822, closed: null, origin: null, lat: 40.6918, lng: -73.9890 },
            { id: 91, name: "St. Jerome", address: "2900 Newkirk Avenue", est: 1901, closed: null, origin: null, lat: 40.6376, lng: -73.9466 },
            { id: 92, name: "St. John the Baptist", address: "75 Lewis Avenue", est: 1868, closed: null, origin: null, lat: 40.6935, lng: -73.9370 },
            { id: 93, name: "St. John Cantius", address: "479 New Jersey Avenue", est: 1902, closed: null, origin: null, lat: 40.6759, lng: -73.8799 },
            { id: 94, name: "St. John the Evangelist", address: "250 21st Street", est: 1850, closed: null, origin: null, lat: 40.6626, lng: -73.9977 },
            { id: 95, name: "St. Joseph", address: "856 Pacific Street", est: 1850, closed: null, origin: null, lat: 40.6792, lng: -73.9649 },
            { id: 96, name: "St. Joseph Patron of the Universal Church", address: "185 Suydam Street", est: 1921, closed: null, origin: null, lat: 40.7018, lng: -73.9196 },
            { id: 97, name: "St. Jude", address: "1677 Canarsie Road", est: 1961, closed: null, origin: null, lat: 40.6339, lng: -73.9006 },
            { id: 98, name: "St. Laurence", address: "1020 Van Siclen Avenue", est: 1964, closed: null, origin: null, lat: 40.6634, lng: -73.8818 },
            { id: 99, name: "St. Leonard of Port Maurice", address: "199 Jefferson Street", est: 1872, closed: null, origin: "German", lat: 40.7027, lng: -73.9258 },
            { id: 100, name: "St. Louis (old)", address: "Ewen and Seigel Streets", est: 1870, closed: 1939, origin: "French", lat: 40.7089, lng: -73.9318 },
            { id: 101, name: "St. Lucy-St. Patrick", address: "285 Willoughby Avenue", est: 1843, closed: null, origin: null, lat: 40.6900, lng: -73.9620 },
            { id: 102, name: "St. Malachy", address: "207 Hendrix Street", est: 1854, closed: null, origin: null, lat: 40.6729, lng: -73.8855 },
            { id: 103, name: "St. Margaret Mary", address: "215 Exeter Place", est: 1920, closed: null, origin: null, lat: 40.5852, lng: -73.9513 },
            { id: 104, name: "St. Mark", address: "2609 East 19th Street", est: 1861, closed: null, origin: null, lat: 40.5878, lng: -73.9497 },
            { id: 105, name: "St. Martin of Tours-Fourteen Holy Martyrs", address: "1288 Hancock Street", est: 1906, closed: null, origin: null, lat: 40.6828, lng: -73.9151 },
            { id: 106, name: "St. Mary, Star of the Sea", address: "467 Court Street", est: 1855, closed: null, origin: null, lat: 40.6758, lng: -73.9993 },
            { id: 107, name: "St. Mary Mother of Jesus", address: "2326 84th Street", est: 1889, closed: null, origin: null, lat: 40.6013, lng: -73.9918 },
            { id: 108, name: "St. Mary of the Angels (old)", address: "S. 4th and Roebling Streets", est: 1896, closed: 1981, origin: null, lat: 40.7103, lng: -73.9582 },
            { id: 109, name: "St. Matthew", address: "1123 Eastern Parkway", est: 1886, closed: null, origin: null, lat: 40.6704, lng: -73.9407 },
            { id: 110, name: "St. Michael", address: "352 42nd Street", est: 1870, closed: null, origin: null, lat: 40.6552, lng: -74.0008 },
            { id: 111, name: "St. Michael (East NY)", address: "225 Jerome Street", est: 1860, closed: null, origin: "German", lat: 40.6742, lng: -73.8789 },
            { id: 112, name: "St. Michael Archangel & St. Edward", address: "108 St. Edward's Place", est: 1891, closed: null, origin: null, lat: 40.6938, lng: -73.9774 },
            { id: 113, name: "St. Nicholas", address: "26 Olive Street", est: 1865, closed: null, origin: "German", lat: 40.7141, lng: -73.9534 },
            { id: 114, name: "St. Patrick", address: "9511 4th Avenue", est: 1849, closed: null, origin: null, lat: 40.6152, lng: -74.0295 },
            { id: 115, name: "St. Peter Claver", address: "29 Claver Place", est: 1921, closed: null, origin: null, lat: 40.6867, lng: -73.9621 },
            { id: 116, name: "St. Peter's-St. Paul's-Our Lady of Pilar", address: "234 Congress Street", est: 1859, closed: null, origin: null, lat: 40.6873, lng: -73.9991 },
            { id: 117, name: "Sts. Peter and Paul", address: "71 South 3rd Street", est: 1844, closed: null, origin: null, lat: 40.7114, lng: -73.9638 },
            { id: 118, name: "St. Rita", address: "275 Shepherd Avenue", est: 1913, closed: null, origin: null, lat: 40.6723, lng: -73.8776 },
            { id: 119, name: "St. Rocco", address: "216 27th Street", est: 1902, closed: null, origin: null, lat: 40.6564, lng: -74.0014 },
            { id: 120, name: "St. Rosalia-Regina Pacis", address: "1230 65th Street", est: 1902, closed: null, origin: null, lat: 40.6219, lng: -73.9869 },
            { id: 121, name: "St. Rose of Lima", address: "269 Parkville Avenue", est: 1870, closed: null, origin: null, lat: 40.6402, lng: -73.9745 },
            { id: 122, name: "St. Saviour", address: "611 8th Avenue", est: 1905, closed: null, origin: null, lat: 40.6668, lng: -73.9860 },
            { id: 123, name: "Sts. Simon and Jude", address: "185 Van Sicklen Street", est: 1897, closed: null, origin: null, lat: 40.5979, lng: -73.9614 },
            { id: 124, name: "St. Stanislaus Kostka", address: "607 Humboldt Street", est: 1896, closed: null, origin: "Polish", lat: 40.7223, lng: -73.9436 },
            { id: 125, name: "St. Stanislaus Martyr (old)", address: "6th Avenue near 14th Street", est: 1891, closed: 1979, origin: null, lat: 40.6683, lng: -73.9858 },
            { id: 126, name: "St. Sylvester", address: "416 Grant Avenue", est: 1923, closed: null, origin: null, lat: 40.6751, lng: -73.8631 },
            { id: 127, name: "St. Teresa of Avila", address: "563 Sterling Place", est: 1874, closed: null, origin: null, lat: 40.6773, lng: -73.9561 },
            { id: 128, name: "St. Therese of Lisieux", address: "1281 Troy Avenue", est: 1926, closed: null, origin: null, lat: 40.6594, lng: -73.9273 },
            { id: 129, name: "St. Thomas Aquinas", address: "249 9th Street", est: 1884, closed: null, origin: null, lat: 40.6686, lng: -73.9879 },
            { id: 130, name: "St. Thomas Aquinas (Flatlands)", address: "1550 Hendrickson Street", est: 1885, closed: null, origin: null, lat: 40.6198, lng: -73.9052 },
            { id: 131, name: "St. Vincent De Paul", address: "167 North 6th Street", est: 1860, closed: null, origin: null, lat: 40.7179, lng: -73.9601 },
            { id: 132, name: "St. Vincent Ferrer", address: "1603 Brooklyn Avenue", est: 1923, closed: null, origin: null, lat: 40.6531, lng: -73.9321 },
            { id: 133, name: "Transfiguration", address: "263 Marcy Avenue", est: 1874, closed: null, origin: null, lat: 40.6984, lng: -73.9519 },
            { id: 134, name: "Visitation of the B.V.M.", address: "98 Richards Street", est: 1854, closed: null, origin: null, lat: 40.6797, lng: -74.0077 }
        ];

        // Kings County (Brooklyn) boundary - accurate coastline following land/water borders
        // Extended to include waterfront neighborhoods like Brooklyn Heights, Carroll Gardens
        const kingsCountyBoundary = {
            "type": "Feature",
            "properties": { "name": "Kings County" },
            "geometry": {
                "type": "Polygon",
                "coordinates": [[
                    // Starting from northwest (Greenpoint) going clockwise
                    [-73.9615, 40.7310], // Greenpoint north at East River
                    [-73.9420, 40.7320], // Newtown Creek mouth
                    [-73.9280, 40.7285], // East of Greenpoint (Queens border)
                    [-73.9120, 40.7140], // Maspeth border
                    [-73.8950, 40.7010], // Ridgewood border
                    [-73.8820, 40.6945], // Cemetery area
                    [-73.8640, 40.6895], // Highland Park
                    [-73.8550, 40.6790], // City Line
                    [-73.8510, 40.6530], // East New York
                    [-73.8550, 40.6370], // Spring Creek
                    [-73.8460, 40.6230], // Jamaica Bay north shore
                    [-73.8590, 40.6095], // Canarsie Pier area
                    [-73.8750, 40.5920], // Dead Horse Bay
                    [-73.8950, 40.5810], // Floyd Bennett Field
                    [-73.9210, 40.5760], // Marine Park
                    [-73.9350, 40.5740], // Gerritsen Beach
                    [-73.9480, 40.5785], // Sheepshead Bay entrance
                    [-73.9580, 40.5745], // Manhattan Beach
                    [-73.9700, 40.5740], // Brighton Beach
                    [-73.9850, 40.5735], // Coney Island east
                    [-74.0030, 40.5720], // Coney Island west
                    [-74.0180, 40.5790], // Sea Gate
                    [-74.0420, 40.5980], // Gravesend Bay
                    [-74.0450, 40.6150], // Fort Hamilton
                    [-74.0460, 40.6400], // Bay Ridge waterfront
                    [-74.0420, 40.6600], // Sunset Park waterfront
                    [-74.0380, 40.6750], // Red Hook waterfront
                    [-74.0220, 40.6850], // Buttermilk Channel / Red Hook
                    [-74.0150, 40.6900], // Atlantic Basin
                    [-74.0080, 40.6940], // Carroll Gardens waterfront
                    [-74.0030, 40.6970], // Columbia St Waterfront
                    [-73.9990, 40.7000], // Brooklyn Heights Promenade
                    [-73.9960, 40.7040], // Brooklyn Bridge Park
                    [-73.9920, 40.7080], // DUMBO waterfront
                    [-73.9870, 40.7120], // Brooklyn Navy Yard south
                    [-73.9750, 40.7160], // Navy Yard
                    [-73.9680, 40.7220], // Williamsburg waterfront
                    [-73.9615, 40.7310]  // Back to start
                ]]
            }
        };

        // State
        let map;
        let markersLayer;
        let voronoiLayer;
        let searchMarkerLayer;
        let currentVoronoiFeatures = null;
        let yearStart = 1822;
        let yearEnd = 2025;
        let showBoundaries = true;
        let selectedOrigin = 'all';
        let addressSearchTimeout = null;
        
        const MIN_YEAR = 1822;
        const MAX_YEAR = 2025;

        // Initialize map
        function initMap() {
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([40.6501, -73.9496], 12);

            // Use CartoDB dark tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
            voronoiLayer = L.layerGroup().addTo(map);
            searchMarkerLayer = L.layerGroup().addTo(map);
            
            // Draw county boundary (subtle)
            L.geoJSON(kingsCountyBoundary, {
                style: {
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    color: 'rgba(74, 111, 165, 0.3)',
                    weight: 2,
                    dashArray: '5, 5'
                }
            }).addTo(map);
            
            updateMap();
        }

        // Get filtered parishes
        function getFilteredParishes() {
            return parishes.filter(p => {
                const estYear = p.est;
                const closedYear = p.closed || 2025;
                
                // Time filter
                const inTimeRange = estYear <= yearEnd && closedYear >= yearStart;
                
                // Origin filter
                const matchesOrigin = selectedOrigin === 'all' || p.origin === selectedOrigin;
                
                return inTimeRange && matchesOrigin;
            });
        }

        // Create Voronoi boundaries clipped to Kings County
        function createVoronoiBoundaries(activeParishes) {
            if (activeParishes.length < 3) return null;
            
            const points = turf.featureCollection(
                activeParishes.map(p => turf.point([p.lng, p.lat], { id: p.id, name: p.name }))
            );
            
            // Create bounding box slightly larger than Kings County
            const bbox = [-74.06, 40.56, -73.83, 40.74];
            
            try {
                const voronoi = turf.voronoi(points, { bbox });
                
                if (!voronoi || !voronoi.features) {
                    console.error('Voronoi generation failed');
                    return null;
                }
                
                // Clip Voronoi cells to Kings County boundary (land only)
                const clippedFeatures = [];
                
                voronoi.features.forEach((feature, i) => {
                    if (!feature || !feature.geometry) return;
                    
                    try {
                        // turf.intersect takes two features directly in v6
                        const clipped = turf.intersect(feature, kingsCountyBoundary);
                        
                        if (clipped) {
                            clipped.properties = activeParishes[i] ? {
                                id: activeParishes[i].id,
                                name: activeParishes[i].name,
                                parish: activeParishes[i]
                            } : {};
                            clippedFeatures.push(clipped);
                        }
                    } catch (e) {
                        // If intersection fails, try using the original feature
                        // This can happen with edge cases
                        console.warn('Intersection failed for parish:', activeParishes[i]?.name, e);
                    }
                });
                
                return turf.featureCollection(clippedFeatures);
            } catch (e) {
                console.error('Voronoi error:', e);
                return null;
            }
        }

        // Find parish for a given point
        function findParishForPoint(lat, lng) {
            if (!currentVoronoiFeatures) return null;
            
            const point = turf.point([lng, lat]);
            
            for (const feature of currentVoronoiFeatures.features) {
                if (feature && feature.geometry) {
                    try {
                        if (turf.booleanPointInPolygon(point, feature)) {
                            return feature.properties.parish || null;
                        }
                    } catch (e) {
                        continue;
                    }
                }
            }
            return null;
        }

        // Update map display
        function updateMap() {
            markersLayer.clearLayers();
            voronoiLayer.clearLayers();
            
            const activeParishes = getFilteredParishes();
            
            // Add Voronoi boundaries
            if (showBoundaries && activeParishes.length >= 3) {
                const voronoi = createVoronoiBoundaries(activeParishes);
                currentVoronoiFeatures = voronoi;
                
                if (voronoi) {
                    L.geoJSON(voronoi, {
                        style: {
                            fillColor: '#d4a853',
                            fillOpacity: 0.06,
                            color: 'rgba(212, 168, 83, 0.35)',
                            weight: 1.5
                        },
                        onEachFeature: (feature, layer) => {
                            if (feature.properties && feature.properties.name) {
                                layer.bindTooltip(feature.properties.name, {
                                    permanent: false,
                                    direction: 'center',
                                    className: 'voronoi-tooltip'
                                });
                            }
                        }
                    }).addTo(voronoiLayer);
                }
            } else {
                currentVoronoiFeatures = null;
            }
            
            // Add markers
            activeParishes.forEach(parish => {
                const isClosed = parish.closed && parish.closed <= yearEnd;
                const markerColor = isClosed ? '#6b7280' : '#d4a853';
                
                const marker = L.circleMarker([parish.lat, parish.lng], {
                    radius: 7,
                    fillColor: markerColor,
                    color: '#16213e',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                });
                
                const popupContent = `
                    <div class="popup-content">
                        <h3>${escapeHtml(parish.name)}</h3>
                        <p>${escapeHtml(parish.address)}</p>
                        ${parish.origin ? `<span class="origin-badge">${escapeHtml(parish.origin)}</span>` : ''}
                        <p class="dates">
                            Est. ${escapeHtml(parish.est)}${parish.closed ? ` ‚Ä¢ Closed ${escapeHtml(parish.closed)}` : ' ‚Ä¢ Active'}
                        </p>
                        ${parish.note ? `<p><em>${escapeHtml(parish.note)}</em></p>` : ''}
                    </div>
                `;
                
                marker.bindPopup(popupContent, { className: 'custom-popup' });
                marker.parishId = parish.id;
                marker.addTo(markersLayer);
            });
            
            // Update stats
            const activeCount = activeParishes.filter(p => !p.closed || p.closed > yearEnd).length;
            const closedCount = activeParishes.filter(p => p.closed && p.closed <= yearEnd).length;
            
            document.getElementById('active-count').textContent = activeCount;
            document.getElementById('closed-count').textContent = closedCount;
            
            // Update parish list
            updateParishList(activeParishes);
        }

        // Update parish list
        function updateParishList(activeParishes) {
            const listContainer = document.getElementById('parish-list');
            const sorted = [...activeParishes].sort((a, b) => a.est - b.est);
            
            listContainer.innerHTML = `
                <div class="list-header">Parishes (${escapeHtml(sorted.length)})</div>
                ${sorted.map(p => `
                    <div class="parish-item" data-id="${escapeHtml(p.id)}">
                        <div class="parish-name">${escapeHtml(p.name)}</div>
                        <div class="parish-meta">${escapeHtml(p.address)}</div>
                        <div class="parish-badges">
                            <span class="parish-badge dates">${escapeHtml(p.est)}${p.closed ? ` ‚Äì ${escapeHtml(p.closed)}` : ' ‚Äì present'}</span>
                            ${p.origin ? `<span class="parish-badge origin">${escapeHtml(p.origin)}</span>` : ''}
                        </div>
                    </div>
                `).join('')}
            `;
            
            // Add click handlers
            document.querySelectorAll('.parish-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = parseInt(item.dataset.id);
                    selectParish(id);
                });
            });
        }

        // Select and zoom to parish
        function selectParish(id) {
            const parish = parishes.find(p => p.id === id);
            if (parish) {
                map.setView([parish.lat, parish.lng], 15);
                markersLayer.eachLayer(layer => {
                    if (layer.parishId === id) {
                        layer.openPopup();
                    }
                });
            }
        }

        // ==================== SEARCH FUNCTIONALITY ====================
        
        // Parish search autocomplete
        const parishSearch = document.getElementById('parish-search');
        const parishAutocomplete = document.getElementById('parish-autocomplete');
        
        parishSearch.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                parishAutocomplete.classList.remove('active');
                return;
            }
            
            // Split query into words and match each word separately
            const queryWords = query.split(/\s+/).filter(w => w.length > 0);
            
            const matches = parishes.filter(p => {
                const searchText = `${p.name} ${p.address}`.toLowerCase();
                // All query words must be found somewhere in the name or address
                return queryWords.every(word => searchText.includes(word));
            }).slice(0, 8);
            
            if (matches.length > 0) {
                parishAutocomplete.innerHTML = matches.map(p => `
                    <div class="autocomplete-item" data-id="${escapeHtml(p.id)}">
                        <div class="autocomplete-name">${escapeHtml(p.name)}</div>
                        <div class="autocomplete-meta">${escapeHtml(p.address)} ‚Ä¢ Est. ${escapeHtml(p.est)}</div>
                    </div>
                `).join('');
                parishAutocomplete.classList.add('active');
                
                // Add click handlers
                parishAutocomplete.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = parseInt(item.dataset.id);
                        selectParish(id);
                        parishSearch.value = '';
                        parishAutocomplete.classList.remove('active');
                    });
                });
            } else {
                parishAutocomplete.classList.remove('active');
            }
        });
        
        parishSearch.addEventListener('blur', () => {
            setTimeout(() => parishAutocomplete.classList.remove('active'), 200);
        });

        // Address search with geocoding (submit-based, not autocomplete)
        const addressSearch = document.getElementById('address-search');
        const addressResult = document.getElementById('address-result');
        const addressSearchBtn = document.getElementById('address-search-btn');
        
        // Search on Enter key
        addressSearch.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performAddressSearch();
            }
        });
        
        // Search on button click
        addressSearchBtn.addEventListener('click', () => {
            performAddressSearch();
        });
        
        function setSearchLoading(isLoading) {
            if (isLoading) {
                addressSearchBtn.disabled = true;
                addressSearchBtn.classList.add('loading');
            } else {
                addressSearchBtn.disabled = false;
                addressSearchBtn.classList.remove('loading');
            }
        }
        
        function performAddressSearch() {
            const query = addressSearch.value.trim();
            
            if (query.length < 3) {
                addressResult.innerHTML = `
                    <div class="address-result-title">Error</div>
                    <div class="address-result-parish" style="font-size: 0.9rem;">Please enter a full address</div>
                `;
                addressResult.classList.add('active');
                return;
            }
            
            // Show loading
            setSearchLoading(true);
            addressResult.innerHTML = `
                <div class="address-result-title">Searching...</div>
                <div class="address-result-parish" style="font-size: 0.85rem; color: var(--text-secondary);">
                    Looking up address in Brooklyn...
                </div>
            `;
            addressResult.classList.add('active');
            
            geocodeAddress(query);
        }
        
        async function geocodeAddress(query) {
            const startTime = Date.now();
            
            try {
                // Use Nominatim - Brooklyn bounding box for faster results
                const searchQuery = query.includes('Brooklyn') ? query : `${query}, Brooklyn, NY`;
                
                const params = new URLSearchParams({
                    format: 'json',
                    q: searchQuery,
                    addressdetails: '1',
                    limit: '1',
                    countrycodes: 'us',
                    viewbox: '-74.05,40.75,-73.82,40.55',
                    bounded: '1'
                });
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?${params}`,
                    { headers: { 'Accept': 'application/json' } }
                );
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                
                // Check for rate limiting
                if (response.status === 429) {
                    setSearchLoading(false);
                    addressResult.innerHTML = `
                        <div class="address-result-title">Rate Limited</div>
                        <div class="address-result-parish" style="font-size: 0.9rem; color: #f59e0b;">
                            Too many requests to the geocoding service
                        </div>
                        <div class="address-result-info">Please wait 30 seconds and try again. Nominatim allows ~1 request/second.</div>
                    `;
                    addressResult.classList.add('active');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const results = await response.json();
                setSearchLoading(false);
                
                if (results && results.length > 0) {
                    const r = results[0];
                    const addr = r.address || {};
                    const lat = parseFloat(r.lat);
                    const lng = parseFloat(r.lon);
                    
                    // Build display address (sanitize external API data)
                    const houseNumber = escapeHtml(addr.house_number || '');
                    const road = escapeHtml(addr.road || '');
                    let displayAddress = '';
                    if (houseNumber && road) {
                        displayAddress = `${houseNumber} ${road}`;
                    } else if (road) {
                        displayAddress = road;
                    } else {
                        displayAddress = escapeHtml(r.display_name.split(',')[0]);
                    }
                    
                    // Show result on map
                    showAddressResult(lat, lng, displayAddress);
                    
                    // Update the input with the found address
                    addressSearch.value = displayAddress;
                    
                    console.log(`Address found in ${elapsed}s`);
                    
                } else {
                    // No results
                    addressResult.innerHTML = `
                        <div class="address-result-title">Not Found</div>
                        <div class="address-result-parish" style="font-size: 0.9rem; color: var(--text-secondary);">
                            No address found in Brooklyn
                        </div>
                        <div class="address-result-info">Try adding more details or check spelling (${elapsed}s)</div>
                    `;
                    addressResult.classList.add('active');
                }
            } catch (error) {
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                console.error('Geocoding error:', error, `after ${elapsed}s`);
                setSearchLoading(false);
                
                let errorTitle = 'Error';
                let errorMessage = 'Something went wrong';
                let errorHint = 'Please try again';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorTitle = 'Network Error';
                    errorMessage = 'Could not connect to geocoding service';
                    errorHint = 'Check your internet connection and try again.';
                } else if (error.message.includes('HTTP')) {
                    errorTitle = 'Server Error';
                    errorMessage = error.message;
                    errorHint = 'The geocoding service may be temporarily unavailable.';
                }
                
                addressResult.innerHTML = `
                    <div class="address-result-title">${errorTitle}</div>
                    <div class="address-result-parish" style="font-size: 0.9rem; color: #ef4444;">
                        ${errorMessage}
                    </div>
                    <div class="address-result-info">${errorHint}</div>
                `;
                addressResult.classList.add('active');
            }
        }
        
        function showAddressResult(lat, lng, displayName) {
            // Clear previous search marker
            searchMarkerLayer.clearLayers();
            
            // Add marker for searched location
            const searchMarker = L.circleMarker([lat, lng], {
                radius: 8,
                fillColor: '#ef4444',
                color: '#ffffff',
                weight: 3,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(searchMarkerLayer);
            
            // Find the parish
            const parish = findParishForPoint(lat, lng);
            
            // Show result in the result panel
            if (parish) {
                addressResult.innerHTML = `
                    <div class="address-result-title">Your Parish</div>
                    <div class="address-result-parish">${escapeHtml(parish.name)}</div>
                    <div class="address-result-info">${escapeHtml(parish.address)} ‚Ä¢ Est. ${escapeHtml(parish.est)}${parish.origin ? ` ‚Ä¢ ${escapeHtml(parish.origin)}` : ''}</div>
                `;
                
                searchMarker.bindPopup(`
                    <div class="popup-content">
                        <h3>Your Parish: ${escapeHtml(parish.name)}</h3>
                        <p>${escapeHtml(parish.address)}</p>
                        <p class="dates">Est. ${escapeHtml(parish.est)}</p>
                    </div>
                `, { className: 'custom-popup' }).openPopup();
            } else {
                addressResult.innerHTML = `
                    <div class="address-result-title">Location Found</div>
                    <div class="address-result-parish" style="color: var(--text-secondary);">Outside Parish Boundaries</div>
                    <div class="address-result-info">This location is outside the current parish catchment areas. Try adjusting the timeline filter.</div>
                `;
            }
            
            addressResult.classList.add('active');
            
            // Zoom to location
            map.setView([lat, lng], 15);
        }

        // ==================== ORIGIN FILTER ====================
        
        document.getElementById('origin-filters').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-chip')) {
                document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                e.target.classList.add('active');
                selectedOrigin = e.target.dataset.origin;
                updateMap();
            }
        });

        // ==================== TIMELINE SLIDER ====================
        
        function initSlider() {
            const container = document.getElementById('slider-container');
            const thumbStart = document.getElementById('thumb-start');
            const thumbEnd = document.getElementById('thumb-end');
            const range = document.getElementById('slider-range');
            
            let isDragging = null;
            
            function getPercent(year) {
                return ((year - MIN_YEAR) / (MAX_YEAR - MIN_YEAR)) * 100;
            }
            
            function getYear(percent) {
                return Math.round(MIN_YEAR + (percent / 100) * (MAX_YEAR - MIN_YEAR));
            }
            
            function updateSliderVisuals() {
                const startPercent = getPercent(yearStart);
                const endPercent = getPercent(yearEnd);
                
                thumbStart.style.left = `${startPercent}%`;
                thumbEnd.style.left = `${endPercent}%`;
                range.style.left = `${startPercent}%`;
                range.style.width = `${endPercent - startPercent}%`;
                
                document.getElementById('year-start').textContent = yearStart;
                document.getElementById('year-end').textContent = yearEnd;
            }
            
            function handleDrag(e) {
                if (!isDragging) return;
                
                const rect = container.getBoundingClientRect();
                const x = (e.clientX || e.touches[0].clientX) - rect.left;
                const percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
                const year = getYear(percent);
                
                if (isDragging === 'start') {
                    yearStart = Math.min(year, yearEnd - 1);
                } else {
                    yearEnd = Math.max(year, yearStart + 1);
                }
                
                updateSliderVisuals();
            }
            
            function startDrag(thumb) {
                isDragging = thumb;
                document.body.style.cursor = 'grabbing';
            }
            
            function endDrag() {
                if (isDragging) {
                    isDragging = null;
                    document.body.style.cursor = '';
                    updateMap();
                }
            }
            
            thumbStart.addEventListener('mousedown', () => startDrag('start'));
            thumbEnd.addEventListener('mousedown', () => startDrag('end'));
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
            
            thumbStart.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag('start'); });
            thumbEnd.addEventListener('touchstart', (e) => { e.preventDefault(); startDrag('end'); });
            document.addEventListener('touchmove', handleDrag);
            document.addEventListener('touchend', endDrag);
            
            updateSliderVisuals();
        }

        // Toggle boundaries
        document.getElementById('toggle-boundaries').addEventListener('click', function() {
            showBoundaries = !showBoundaries;
            this.classList.toggle('active', showBoundaries);
            this.textContent = showBoundaries ? 'Show Boundaries' : 'Hide Boundaries';
            updateMap();
        });

        // ==================== MOBILE TOGGLE ====================
        
        function initMobileToggle() {
            const mobileToggle = document.getElementById('mobile-toggle');
            const sidebar = document.querySelector('.sidebar');
            
            if (!mobileToggle || !sidebar) return;
            
            mobileToggle.addEventListener('click', () => {
                const isVisible = sidebar.classList.toggle('mobile-visible');
                mobileToggle.classList.toggle('showing-controls', isVisible);
                mobileToggle.textContent = isVisible ? 'Show Map' : 'Show Controls';
                
                // Invalidate map size when toggling (fixes rendering issues)
                if (!isVisible && map) {
                    setTimeout(() => map.invalidateSize(), 350);
                }
            });
            
            // Close sidebar when clicking on a parish item (on mobile)
            document.getElementById('parish-list').addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && e.target.closest('.parish-item')) {
                    sidebar.classList.remove('mobile-visible');
                    mobileToggle.classList.remove('showing-controls');
                    mobileToggle.textContent = 'Show Controls';
                    setTimeout(() => map.invalidateSize(), 350);
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initSlider();
            initMobileToggle();
        });
    </script>
</body>
</html>
